function getGameId(e){var r;for(i=0;i<sockets.length;i++)if(sockets[i]==e){r=players[i].gameId;break}return r}function getGameData(e){var r;for(i=0;i<gameRoom.length;i++)if(gameRoom[i].gameId==e){tempPlayers=gameRoom[i].players,r=gameRoom[i];break}return r}function updateGameData(e,r){for(i=0;i<gameRoom.length;i++)if(gameRoom[i].gameId==r){gameRoom[i]=e;break}}function generateGrid(e,r,a){var o=e/4,n=new Array;for(i=0;i<e;i++)n.push(i);var t=new Array;for(i=0;i<4;i++)t.push(i*o),t.push(i*o+1),o>4&&t.push(i*o+2),o>7&&t.push(i*o+3),o>10&&t.push(i*o+4),o>12&&t.push(i*o+5);var l=new Array;for(i=0;i<4;i++)o>12&&l.push(i*o+o-6),o>10&&l.push(i*o+o-5),o>7&&l.push(i*o+o-4),o>4&&l.push(i*o+o-2),l.push(i*o+o-2),l.push(i*o+o-1);var s=new Array;if(s.length=n.length,4>=o)if(0==r){for(rand=getFromArray(t),s[rand]="I",n=remove(n,n.indexOf(rand)),i=0;i<3;i++)rand=getFromArray(n),s[rand]="O",n=remove(n,n.indexOf(rand));for(;n&&n.length;)rand=getFromArray(n),s[rand]="T",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="S",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="Z",n=remove(n,n.indexOf(rand));LOG&&console.log(s)}else if(i==a){for(rand=getFromArray(l),s[rand]="I",n=remove(n,n.indexOf(rand)),i=0;i<3;i++)rand=getFromArray(n),s[rand]="O",n=remove(n,n.indexOf(rand));for(;n&&n.length;)rand=getFromArray(n),s[rand]="T",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="S",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="Z",n=remove(n,n.indexOf(rand))}else{for(rand=getFromArray(n),s[rand]="I",n=remove(n,n.indexOf(rand)),i=0;i<3;i++)rand=getFromArray(n),s[rand]="O",n=remove(n,n.indexOf(rand));for(;n&&n.length;)rand=getFromArray(n),s[rand]="T",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="S",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="Z",n=remove(n,n.indexOf(rand))}else if(o>4&&7>=o)if(0==r){for(LOG&&console.log("First Device"),rand=getFromArray(t),s[rand]="I",n=remove(n,n.indexOf(rand)),i=0;i<2;i++)rand=getFromArray(n),s[rand]="O",n=remove(n,n.indexOf(rand));for(;n&&n.length;)rand=getFromArray(n),s[rand]="T",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="S",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="Z",n&&(n=remove(n,n.indexOf(rand)))}else if(i==a){for(LOG&&console.log("Last Device"),rand=getFromArray(l),s[rand]="I",n=remove(n,n.indexOf(rand)),i=0;i<3;i++)rand=getFromArray(n),s[rand]="O",n=remove(n,n.indexOf(rand));for(;n&&n.length;)rand=getFromArray(n),s[rand]="T",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="S",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="Z",n&&(n=remove(n,n.indexOf(rand)))}else{for(rand=getFromArray(n),s[rand]="I",n=remove(n,n.indexOf(rand)),i=0;i<3;i++)rand=getFromArray(n),s[rand]="O",n=remove(n,n.indexOf(rand));for(;n&&n.length;)rand=getFromArray(n),s[rand]="T",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="S",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="Z",n&&(n=remove(n,n.indexOf(rand)))}else if(o>7&&10>=o){for(rand=getFromArray(t),s[rand]="I",n=remove(n,n.indexOf(rand)),rand=getFromArray(l),s[rand]="I",n=remove(n,n.indexOf(rand)),i=0;i<6;i++)rand=getFromArray(n),s[rand]="O",n=remove(n,n.indexOf(rand));for(;n&&n.length;)rand=getFromArray(n),s[rand]="T",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="S",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="Z",n=remove(n,n.indexOf(rand))}else if(o>10&&12>=o){for(rand=getFromArray(t),s[rand]="I",n=remove(n,n.indexOf(rand)),rand=getFromArray(l),s[rand]="I",n=remove(n,n.indexOf(rand)),i=0;i<7;i++)rand=getFromArray(n),s[rand]="O",n=remove(n,n.indexOf(rand));for(;n&&n.length;)rand=getFromArray(n),s[rand]="T",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="S",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="Z",n=remove(n,n.indexOf(rand))}else{for(rand=getFromArray(t),s[rand]="I",n=remove(n,n.indexOf(rand)),rand=getFromArray(l),s[rand]="I",n=remove(n,n.indexOf(rand)),i=0;i<8;i++)rand=getFromArray(n),s[rand]="O",n=remove(n,n.indexOf(rand));for(;n&&n.length;)rand=getFromArray(n),s[rand]="T",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="S",n=remove(n,n.indexOf(rand)),rand=getFromArray(n),s[rand]="Z",n=remove(n,n.indexOf(rand))}return s}function getFromArray(e){return LOG&&console.log("Printing the getFrom Array "),LOG&&console.log(e),e?e[Math.floor(Math.random()*e.length)]:void 0}function remove(e,r){return r>-1?(e.splice(r,1),e):void 0}function createGameId(){var e,r=["a","b","c","d","e","f","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"];for(e=getFromArray(r).toString().toUpperCase()+getFromArray(r).toString().toUpperCase()+getFromArray(r).toString().toUpperCase()+getFromArray(r).toString().toUpperCase();gameIdList.indexOf(e)>-1;)e=getFromArray(r).toString().toUpperCase()+getFromArray(r).toString().toUpperCase()+getFromArray(r).toString().toUpperCase()+getFromArray(r).toString().toUpperCase();return gameIdList.push(e),lastCreatedId=e,LOG&&console.log(e),LOG&&console.log(gameIdList),e}function compare(e,r){return e.x<r.x?-1:e.x>r.x?1:0}var express=require("express"),cors=require("cors"),pF=require("pathfinding"),app=express(),LOG=!1,LOGO=!1,wurfl_cloud_client=require("wurflcloud/NodeWurflCloudClient/WurflCloudClient"),config=require("wurflcloud/NodeWurflCloudClient/Config"),api_key="290356:OLAdGwqJ715I8lQ9vj2UsbStDRYmoznB",configuration=new config.WurflCloudConfig(api_key);LOG&&console.log("Configured Wurfl"),app.use(cors());var server=require("http").createServer(app),io=require("socket.io")(server),port=process.env.PORT||5e3;server.listen(port,function(){LOG&&console.log("Server listening at 5000")}),app.use(express["static"](__dirname+"/public"));var gameRoom=[],players=[],sockets=[],playerIdBase=-1,gameIdList=new Array,gameIndex=-1,gameLinearGrid=new Array,lastCreatedId;io.on("connection",function(e){LOG&&console.log("---------------------------------------------------------------------------"),LOG&&console.log("Player Connected");var r=new Object;r.id=playerIdBase+1,playerIdBase++,players.push(r),sockets.push(e),e.on("createGame",function(r){LOG&&console.log("Game Created By Host"),LOG&&console.log(r.size),LOG&&console.log("Game Created");var a=createGameId(),o=new Object;for(o.gameId=a,o.players=new Array,i=0;i<sockets.length;i++)sockets[i]==e&&(players[i].gameId=o.gameId,players[i].isHost=!0,players[i].size=r.size,players[i].clan=r.clan,o.players&&(players[i].index=o.players.length+1),o.players.push(players[i]),o.host=players[i],o.ready=0,o.universal=[],o.colsOffset=[],o.submitCount=0,o.pathMap=[],o.totalCols=0,o.shrineData=[],o.paths=[],o.highlight=[],o.score=0);o.playersJoined=1,gameRoom.push(o);var n=gameRoom.length-1;e.emit("demoHostGameSetup",JSON.stringify(gameRoom[n]))}),e.on("joinGame",function(r){LOG&&console.log("Joined Game");var a=0;for(LOG&&console.log(r.size),i=0;i<gameRoom.length;i++)if(gameRoom[i].gameId==r.gameId)for(j=0;j<sockets.length;j++)if(sockets[j]==e){players[j].gameId=gameRoom[i].gameId,players[j].isHost=!1,players[j].size=r.size,players[j].clan=r.clan,gameRoom[i].players&&(players[j].index=gameRoom[i].players.length+1),gameRoom[i].players.push(players[j]),gameRoom[i].playersJoined++,e.emit("demoPlayerJoined",JSON.stringify(gameRoom[i])),a=1;break}a||e.emit("wrongGameIdEntered")}),e.on("buildSubmited",function(r){var a,o;a=getGameId(e),o=getGameData(a);var i=r.index;LOG&&console.log("Build Submit Data"),LOG&&console.log(JSON.stringify(o)),LOG&&console.log(i);var n=0;LOG&&console.log(JSON.stringify(r.grid));for(var t=0;4>t;t++)for(var l=o.colsOffset[i];l<o.colsOffset[i]+o.players[i].cols;l++)o.universal[t][l]=r.grid[n],n++;if(o.submitCount++,o.submitCount==o.playersJoined){for(t=0;t<o.players.length;t++)sockets[o.players[t].id].emit("buildingBoard");for(var t=0;4>t;t++)for(var l=0;l<o.totalCols;l++)if(("I"==o.universal[t][l]||"X"==o.universal[t][l])&&(o.pathMap[t][l]=0,"I"==o.universal[t][l])){var s=new Object;s.x=l,s.y=t,o.shrineData.push(s)}for(o.shrineData.sort(compare),t=0;t<o.shrineData.length-1;t++){var d=new Object,g=new Object;g.x=o.shrineData[t].x,g.y=o.shrineData[t].y;var m=new Object;m.x=o.shrineData[t+1].x,m.y=o.shrineData[t+1].y,d.start=g,d.end=m,d.path=[],o.paths.push(d)}for(t=0;t<o.paths.length;t++){LOG&&console.log("I am here for "+t);var p=new pF.Grid(o.pathMap),h=new pF.AStarFinder;o.paths[t].path=h.findPath(o.paths[t].start.x,o.paths[t].start.y,o.paths[t].end.x,o.paths[t].end.y,p),LOG&&console.log("I am done for "+t),LOG&&console.log("Builded path for "+t+" : "+o.paths[t].path)}var c=1,f=new Array;for(t=0;t<o.paths.length;t++)if(0==o.paths[t].path.length)c=0;else for(l=0;l<o.paths[t].path.length;l++)f.push(o.paths[t].path[l]),o.score++;for(c?LOG&&console.log("The Path is build"):LOG&&console.log("Failed to Build Path"),LOG&&console.log("illuminate:"),LOG&&console.log(JSON.stringify(f)),LOG&&console.log("gameData before Score"),LOG&&console.log(o.score),o.score=o.score*o.playersJoined*10,LOG&&console.log("Consoling Score After"),LOG&&console.log(o.score),LOG&&console.log("Total Cols"),LOG&&console.log(o.totalCols),t=0;t<f.length;t++)o.highlight[f[t][1]][f[t][0]]=1;LOG&&console.log("Higlight Array:"),LOG&&console.log(JSON.stringify(o.highlight));var y=[];for(k=0;k<o.playersJoined;k++){n=0;var O=[];for(t=0;4>t;t++)for(l=o.colsOffset[k];l<o.colsOffset[k]+o.players[k].cols;l++)O[n]=o.highlight[t][l],n++;y.push(O)}for(LOG&&console.log("/n/nIndividual Higlight:"),LOG&&console.log(JSON.stringify(y)),LOG&&console.log("/n/nAll Set to Roll"),updateGameData(o,a),LOG&&console.log(JSON.stringify(o.universal)),LOG&&console.log(JSON.stringify(o.pathMap)),LOG&&console.log(JSON.stringify(o.shrineData)),LOG&&console.log(JSON.stringify(o.paths)),t=0;t<o.players.length;t++){var u=new Object;u.won=c,u.highlight=y[t],u.gameData=o,sockets[o.players[t].id].emit("highlight",u)}}}),e.on("requestGameData",function(){for(i=0;i<sockets.length;i++)if(sockets[i]==e)for(j=0;j<gameRoom.length;j++)if(gameRoom[j].gameId==players[i].gameId){e.emit("requestGameData",JSON.stringify(gameRoom[j]));break}}),e.on("updateGlobalStatus",function(){var r,a;for(r=getGameId(e),a=getGameData(r),LOG&&console.log(a),i=0;i<a.players.length;i++)sockets[a.players[i].id].emit("updateGlobalStatus",a)}),e.on("replay",function(){var r,a;for(r=getGameId(e),a=getGameData(r),LOG&&console.log(a),i=0;i<a.players.length;i++)sockets[a.players[i].id].emit("replayFromServer")}),e.on("alignScreens",function(){var r,a;for(r=getGameId(e),a=getGameData(r),LOG&&console.log(a),i=0;i<a.players.length;i++)sockets[a.players[i].id].emit("alignScreens",a.players[i].index)}),e.on("transferMelk",function(r){LOG&&console.log("Transfer Data ******************************************");var a,o;for(LOG&&console.log(JSON.stringify(r)),a=getGameId(e),o=getGameData(a),i=0;i<o.players.length;i++)o.players[i].index==r.to&&sockets[o.players[i].id].emit("transferMelk",r)}),e.on("generateBoard",function(){var r,a,o;r=getGameId(e),a=getGameData(r);{var n=new Array;new Array}for(o=a.playersJoined,i=0;i<o;i++)n.push(parseInt(a.players[i].size.height));for(min=Math.min.apply(Math,n),LOG&&console.log(min),smallestI=n.indexOf(min),minHeight=a.players[smallestI].size.height,minWidth=a.players[smallestI].size.width,boardHeight=minWidth,a.boardHeight=boardHeight,a.tileSize=boardHeight/5,boardParams=new Object,boardParams.boardHeight=boardHeight,boardParams.ratio=a.players[smallestI].size.ratio,basePlayerIndex=smallestI,tileSize=boardHeight/5,i=0;i<a.players.length;i++)i==basePlayerIndex?(a.players[i].tileSize=tileSize,a.players[i].cols=5):(tileSize=boardHeight/5,width=a.players[i].size.width,tempCol=Math.floor(width/tileSize),remainder=width-tempCol*tileSize,extra=remainder/tempCol,tileSize+=extra,a.players[i].tileSize=tileSize,a.players[i].cols=tempCol);for(updateGameData(a,r),a=getGameData(r),z=0;z<a.players.length;z++)o=4*a.players[z].cols,index=z,a.players[z].gameLinearGrid=generateGrid(o,index,a.players.length-1,a.players[z].size.userAgent);for(updateGameData(a,r),a=getGameData(r),LOG&&console.log("List of generated grids -----------------------------"),i=0;i<a.players.length;i++){{new Object}boardParams.boardHeight=boardHeight,boardParams.size=a.players[i].size,boardParams.playerId=a.players[i].id,boardParams.tileSize=a.players[i].tileSize,boardParams.cols=a.players[i].cols,boardParams.linearGrid=a.players[i].gameLinearGrid,LOG&&console.log(boardParams),sockets[a.players[i].id].emit("drawBoard",boardParams)}}),e.on("execute",function(){var r,a,o;r=getGameId(e),a=getGameData(r);{var i=new Array,n=new Array;new Array}for(o=a.playersJoined,t=0;o>t;t++)i.push(parseInt(a.players[t].size.pHeight)),n.push(parseInt(a.players[t].size.pWidth));for(LOGO&&console.log(JSON.stringify(i)),LOGO&&console.log(JSON.stringify(n)),min=Math.min.apply(null,i),max=Math.max.apply(null,i),minW=Math.min.apply(null,n),maxW=Math.max.apply(null,n),total=0,backRatio=3583/1299,t=0;o>t;t++)total+=n[t];for(panRatio=total/max,backHeight=max,backWidth=backHeight*backRatio,backData=new Object,backData.height=backHeight,backData.width=backWidth,backData.widths=n,backData.n=o,LOGO&&console.log("-------------------------------------"),LOGO&&console.log("min max heights: "+min+"/"+max),LOGO&&console.log("min max widths: "+minW+"/"+maxW),LOGO&&console.log("no of screens: "+o),LOGO&&console.log("back h w: "+backHeight+" "+backWidth),LOGO&&console.log("-------------------------------------"),LOG&&console.log(min),smallestI=i.indexOf(min),minHeight=a.players[smallestI].size.pHeight,minWidth=a.players[smallestI].size.pWidth,boardHeight=minWidth,a.boardHeight=boardHeight,a.tileSize=boardHeight/4,boardParams=new Object,boardParams.boardHeight=boardHeight,boardParams.ratio=a.players[smallestI].size.ratio,basePlayerIndex=smallestI,tileSize=boardHeight/4,t=0;t<a.players.length;t++)t==basePlayerIndex?(a.players[t].tileSize=tileSize,a.players[t].cols=4):(tileSize=boardHeight/4,width=a.players[t].size.pWidth,tempCol=Math.floor(width/tileSize),remainder=width-tempCol*tileSize,extra=remainder/tempCol,tileSize+=extra,a.players[t].tileSize=tileSize,a.players[t].cols=tempCol);for(updateGameData(a,r),a=getGameData(r),z=0;z<a.players.length;z++)o=4*a.players[z].cols,index=z,a.players[z].gameLinearGrid=generateGrid(o,index,a.players.length-1,a.players[z].size.userAgent);for(updateGameData(a,r),a=getGameData(r),totalCols=0,t=0;t<a.players.length;t++)a.colsOffset.push(totalCols),totalCols+=a.players[t].cols;a.totalCols=totalCols;for(var t=0;4>t;t++){a.universal[t]=[],a.pathMap[t]=[],a.highlight[t]=[];for(var l=0;l<totalCols;l++)a.universal[t][l]=null,a.pathMap[t][l]=1,a.highlight[t][l]=0}for(updateGameData(a,r),LOG&&console.log(JSON.stringify(a.universal)),LOG&&console.log("List of generated grids -----------------------------"),t=0;t<a.players.length;t++){{new Object}boardParams.boardHeight=boardHeight,boardParams.size=a.players[t].size,boardParams.playerId=a.players[t].id,boardParams.tileSize=a.players[t].tileSize,boardParams.cols=a.players[t].cols,boardParams.pWidth=a.players[t].size.pWidth,boardParams.pHeight=a.players[t].size.pHeight,boardParams.linearGrid=a.players[t].gameLinearGrid,backData.index=a.players[t].index-1,boardParams.backData=backData,boardParams.clan=a.players[t].clan,LOG&&console.log(boardParams),sockets[a.players[t].id].emit("demoDrawBoard",boardParams)}}),e.on("clanSelected",function(){{var r=getGameId(e);getGameData(r)}for(i=0;i<sockets.length;i++)sockets[i]==e}),e.on("endGame",function(){{var r=getGameId(e);getGameData(r)}for(i=0;i<gameRoom.length;i++)if(gameRoom[i].gameId==r){remove(gameRoom,i);break}LOG&&console.log(gameRoom),e.emit("endGame")}),e.on("log",function(e){LOGO&&console.log("From Client ``````````````````````````"),LOGO&&console.log(e)}),e.on("updateReady",function(){var r=getGameId(e);for(i=0;i<gameRoom.length;i++)if(gameRoom[i].gameId==r){gameRoom[i].ready++;break}var a=getGameData(r);if(LOG&&console.log(a.ready),a.ready==a.playersJoined)for(LOG&&console.log("Start The Game"),j=0;j<a.players.length;j++)sockets[a.players[j].id].emit("showMoto")}),e.on("requestDeviceData",function(){var r=e.request,a=e.response;LOG&&console.log("Started The Request function");var o=new Object,i=new wurfl_cloud_client.WurflCloudClient(configuration,r,a);i.detectDevice(r,null,function(){LOG&&console.log("Done setting up the inner function"),i.getDeviceCapability("physical_screen_width",function(r,a){null!=r?(LOG&&console.log("Errr from Width"),LOG&&console.log("Error"+r),o.pwidth=null,LOG&&console.log("Null set from Width")):(LOG&&console.log("Printing The Width"),LOG&&console.log("Physical width: "+a),o.pwidth=a,LOG&&console.log("Now going for HEight"),i.getDeviceCapability("physical_screen_height",function(r,a){null!=r?(LOG&&console.log("Error"+r),o.pheight=null):(LOG&&console.log("Printing The Height"),LOG&&console.log("Physical height: "+a),o.pheight=a,LOG&&console.log("Sending this data to the client:"+o),LOG&&console.log(o),e.emit("deviceData",o))}))})})})});